<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Poker Link — Réinitialisation</title>
    <meta name="robots" content="noindex,nofollow" />
    <style>
      body{
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
        background:linear-gradient(135deg,#059669 0%,#047857 100%);
        min-height:100vh;
        margin:0;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:20px;
        color:#111827;
      }
      .card{
        background:#fff;
        border-radius:20px;
        max-width:520px;
        width:100%;
        padding:28px 22px;
        box-shadow:0 20px 60px rgba(0,0,0,.25);
        text-align:center;
      }
      .logo{
        display:flex;
        justify-content:center;
        align-items:center;
        gap:10px;
        margin-bottom:10px;
      }
      .logo img{ width:44px;height:44px;object-fit:contain; }
      h1{ font-size:22px;margin:10px 0 6px; }
      p{ color:#6b7280; margin:0 0 14px; line-height:1.5; }
      .spinner{
        width:34px;height:34px;border-radius:50%;
        border:4px solid rgba(255,255,255,.35);
        border-top-color:#059669;
        margin:16px auto 12px;
        animation:spin 1s linear infinite;
      }
      @keyframes spin{ to{ transform:rotate(360deg); } }
      .btn{
        display:inline-flex;align-items:center;justify-content:center;
        padding:12px 18px;border-radius:12px;
        background:#059669;color:#fff;text-decoration:none;font-weight:700;
        border:0; cursor:pointer;
      }
      .btn:hover{ background:#047857; }
      .small{ margin-top:12px; font-size:12px; color:#6b7280; }
      code{ background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    </style>
  </head>
  <body>
    <main class="card">
      <div class="logo">
        <img src="/assets/logo.png" alt="Poker Link" />
        <strong>Poker Link</strong>
      </div>
      <h1>Ouverture de la page de réinitialisation…</h1>
      <p>Merci de patienter quelques secondes.</p>
      <div class="spinner" aria-hidden="true"></div>

      <button id="openBtn" class="btn" type="button" style="display:none;">
        Continuer
      </button>

      <div class="small" id="hint"></div>
    </main>

    <script>
      (function () {
        // ✅ On évite d'afficher l'URL supabase dans l'email.
        // Cette page (pokerlink.app) redirige vers l’Edge Function avec les query params.
        var params = new URLSearchParams(window.location.search);

        var tokenHash = params.get("token_hash");
        var type = params.get("type") || "recovery";

        // URL Edge Function (celle dont Bolt parle)
        var targetBase = "https://biyazvpfdwrhurkwolra.supabase.co/functions/v1/reset-password-page";

        // Construire l'URL finale
        var target = targetBase + "?type=" + encodeURIComponent(type);
        if (tokenHash) target += "&token_hash=" + encodeURIComponent(tokenHash);

        var hint = document.getElementById("hint");
        var btn = document.getElementById("openBtn");

        function go() {
          window.location.replace(target);
        }

        // Si pas de token_hash, on affiche un message clair
        if (!tokenHash) {
          hint.innerHTML = "Lien incomplet. Merci de revenir à l’email et de cliquer sur le bouton de réinitialisation.";
          btn.style.display = "inline-flex";
          btn.textContent = "Retour à l’accueil";
          btn.onclick = function(){ window.location.href = "/"; };
          return;
        }

        // Sinon on redirige automatiquement
        hint.innerHTML = "Redirection… (<code>reset-password-page</code>)";
        setTimeout(go, 150);

        // Fallback bouton
        btn.style.display = "inline-flex";
        btn.textContent = "Continuer";
        btn.onclick = go;
      })();
    </script>
  </body>
</html>
